(function(b){function h(a){this.logs={};this.logList=[];this.paused=!1;this.request=null;this.lastId=-1;this.logTemplate=b("#logTemplate").attr("id",null);this.applicationName=a;b("#pageTitle").text(a+" | Debug Log");this.pull();this.updateInterval=setInterval(b.proxy(this.update,this),15E3)}function k(a,b,c,d,e){1==a&&void 0!==e&&(d=e);return a>=c?'<span class="label label-important">'+a+d+"</span>":a>=b?'<span class="label label-warning">'+a+d+"</span>":a+d}function m(a){if(!a||!a.log)return"";
for(var f=a.log,c=b("<ol></ol>"),d=0;d<f.length;d++){var e=f[d],g=e.time;c.append(b("<li></li>").text(parseFloat(g).toFixed(4)+": "+e.title))}f="Date: "+(new Date(a.date)).toString()+"<br />Execution Time: "+parseFloat(a.executionTime).toFixed(4)+"s<br />Peak Memory Usage: ";a=a.memoryUsage;for(d=0;1024<a;)a/=1024,d++;a=parseFloat(a).toFixed(2)+" "+["B","KB","MB","GB","TB"][d];return[b("<p></p>").html(f+a),c]}function n(a){if(!a||!a.length)return"No Errors";for(var f=b("<ol></ol>"),c=0;c<a.length;c++){var d=
a[c],e=d.time;f.append(b("<li></li>").append(b('<pre class="prettyprint"/>').text(parseFloat(e).toFixed(4)+": "+d.error)))}return f}function p(a){if(!a||!a.queries)return"";for(var f=b("<ol></ol>"),c=0,d=0;d<a.queries.length;d++){var e=a.queries[d],g=e.etime-e.stime,h=parseFloat(e.stime).toFixed(4)+"s ("+parseFloat(g).toFixed(4)+"s)",c=c+g;f.append(b("<li></li>").append(b('<pre class="prettyprint"/>').text(h+": "+e.query)))}return[b("<p></p>").text("Executed "+(1==a.queries.length?"1 query":a.queries.length+
" queries")+" in "+parseFloat(c).toFixed(4)+"s with "+(1==a.errors?"1 error":a.errors+" errors")),f]}function l(a,b){var c=Math.round(b-a)/1E3,d;90>c?(d=["second","seconds"],c=Math.floor(c)):3600>c?(d=["minute","minutes"],c=Math.floor(c/60)):86400>c?(d=["hour","hours"],c=Math.floor(c/60/60)):(d=["day","days"],c=Math.floor(c/60/60/24));return c+" "+(1==c?d[0]:d[1])+" ago"}window.ErrorLog=h;h.prototype.pull=function(){var a=this;b.ajax({type:"GET",url:"/api/ErrorLog/pull",data:{lastId:this.lastId},
success:function(b,c,d){a.receive(b,c,d)},complete:function(){a.request||a.longPull()}});this.update()};h.prototype.longPull=function(){this.request&&4!=this.request.readyState&&this.request.abort();if(!this.paused){clearInterval(this.updateInterval);this.updateInterval=setInterval(b.proxy(this.update,this),15E3);var a=this;this.request=b.ajax({type:"GET",url:"/api/ErrorLog/waitForNext",data:{lastId:this.lastId},dataType:"json",success:function(b,c,d){a.receive(b,c,d);d==a.request&&(a.request=null,
setTimeout(function(){a.longPull()},b&&b.length?250:15E3))},error:function(b,c,d){b==a.request&&(a.request=null,setTimeout(function(){a.longPull()},15E3))}})}};h.prototype.pause=function(){this.paused=!0;b("a#pauseButton").hide();b("a#resumeButton").show();this.request&&this.request.abort()};h.prototype.resume=function(){this.paused=!1;b("a#pauseButton").show();b("a#resumeButton").hide();this.longPull()};h.prototype.clearLog=function(){b("#logList").empty();this.logs={};this.logList=[];0<b('input[name="clearDelete"]:checked').length&&
b.ajax({type:"GET",url:"/api/ErrorLog/clearLog",data:null})};h.prototype.receive=function(a,b,c){for(b=0;b<a.length;b++)c=a[b],this.logs[c.id]||(c.id>this.lastId&&(this.lastId=c.id),this.logs[c.id]=c,this.logList.push(c),this.displayLog(c))};h.prototype.update=function(){var a=new Date,f=this;b("#errorLog .logHeader td:nth-child(4)").each(function(c,d){$td=b(d);var e=$td.parents(".accordion-toggle").attr("href").substr(4),e=l(new Date(f.logs[e].date),a);e!=$td.text()&&$td.text(e)});!this.paused&&
(!this.request||4==this.request.readyState)&&this.longPull()};h.prototype.displayLog=function(a){var f=this.logTemplate.clone();f.find(".accordion-toggle").attr("href","#log"+a.id);f.find(".accordion-body").attr("id","log"+a.id);var c=f.find(".logHeader td"),d=(a.errors?a.errors.length:0)||0;d?b(c.get(0)).append('<span class="badge badge-important">'+d+"</span>"):b(c.get(0)).append('<span class="label label-success">OK</span>');b(c.get(1)).html(k(a.responseCode,400,500,"",""));b(c.get(2)).text(a.requestMethod);
b(c.get(3)).text(l(new Date(a.date),new Date));b(c.get(4)).text(a.requestPath||"/");var e=a.queries?a.queries.queries.length:0;b(c.get(5)).html(k(e,25,50," queries"," query"));var g=parseFloat(a.executionTime).toFixed(4)+"s";b(c.get(6)).html(k(g,0.2,0.5,"",""));c=a.log&&a.log.length||0;g=f.find(".nav-tabs li a");b(g[0]).attr("href","#t0"+a.id);b(g[1]).attr("href","#t1"+a.id).find("span").text(d);b(g[2]).attr("href","#t2"+a.id).find("span").text(c);b(g[3]).attr("href","#t3"+a.id).find("span").text(e);
e=f.find(".tab-content > div");b(e[0]).attr("id","t0"+a.id).html('<pre class="prettyprint">'+JSON.stringify(a.request,void 0,2)+"</pre>");b(e[1]).attr("id","t1"+a.id).append(n(a.errors));b(e[2]).attr("id","t2"+a.id).append(m(a));b(e[3]).attr("id","t3"+a.id).html(p(a.queries));a=0;d?a=1:c&&(a=2);b(g[a]).parent().add(e[a]).addClass("active");b("#logList").prepend(f.children());window.prettyPrint&&prettyPrint()}})(jQuery);
